<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CGM Butler - AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 1000px;
            height: 750px;
            display: flex;
            flex-direction: column;
            border: 1px solid #e5e7eb;
        }

        .chat-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            flex: 1;
        }

        .chat-header h1 {
            font-size: 1.5em;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 4px;
        }

        .chat-header p {
            font-size: 0.875em;
            color: #6b7280;
        }

        .header-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .user-selector select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875em;
            min-width: 200px;
            cursor: pointer;
            background: white;
            color: #374151;
            transition: all 0.2s;
        }

        .user-selector select:hover {
            border-color: #3b82f6;
        }

        .user-selector select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .avatar-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #3b82f6;
            color: #3b82f6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875em;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .avatar-btn:hover {
            background: #eff6ff;
        }

        .avatar-btn.active {
            background: #3b82f6;
            color: white;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: #f9fafb;
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 8px;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 0.9375em;
        }

        .message.user .message-content {
            background: #3b82f6;
            color: white;
        }

        .message.bot .message-content {
            background: white;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .message.system .message-content {
            background: #fef3c7;
            color: #92400e;
            font-size: 0.875em;
            max-width: 90%;
            margin: 0 auto;
            text-align: center;
            border: 1px solid #fde68a;
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            width: fit-content;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .quick-buttons {
            padding: 16px 24px;
            background: white;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            border-top: 1px solid #e5e7eb;
        }

        .quick-btn {
            padding: 8px 14px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875em;
            color: #374151;
            transition: all 0.2s;
        }

        .quick-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .chat-input {
            padding: 20px 24px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9375em;
            outline: none;
            transition: all 0.2s;
        }

        .chat-input input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .chat-input button {
            padding: 10px 24px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9375em;
            font-weight: 500;
            transition: all 0.2s;
        }

        .chat-input button:hover {
            background: #2563eb;
        }

        .chat-input button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .function-badge {
            display: inline-block;
            padding: 3px 10px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 12px;
            font-size: 0.75em;
            margin-top: 8px;
            font-weight: 500;
        }

        /* Scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Modal styles for video avatar */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex !important;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 92vw;
            height: 92vh;
            max-width: 1400px;
            max-height: 900px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-header h2 {
            font-size: 1.25em;
            font-weight: 600;
            color: #1e3a8a;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
        }

        .modal-close:hover {
            color: #1e3a8a;
        }

        .modal-body {
            flex: 1;
            overflow: visible;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
            min-height: 0;
        }

        .video-container {
            width: 100%;
            height: 100%;
            flex: 1;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
            background: #f9fafb;
            min-height: 0;
        }

        .video-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            flex: 1;
        }

        .video-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            height: 100%;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #6b7280;
            font-size: 0.9375em;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="header-left">
                <h1>🩺 Olivia - Your Health Butler</h1>
                <p>Caring, Intelligent Glucose Management Support</p>
            </div>
            <div class="header-right">
                <div class="user-selector">
                    <select id="userSelect" onchange="changeUser()">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <button class="avatar-btn" onclick="toggleAvatar()" id="avatarBtn">
                    <span>🎥</span>
                    <span>Video Avatar</span>
                </button>
            </div>
        </div>

        <div class="chat-messages" id="messages">
            <div class="message bot">
                <div class="message-content">
👋 Hello! I'm Olivia, your personal health butler.

I'm here to help you understand your glucose data and support you on your health journey. Think of me as your caring companion who's always in your corner!

I can help you with:
• 📊 Checking your current glucose levels
• 🔍 Spotting patterns in your data
• 💡 Suggesting personalized tips
• 📈 Celebrating your progress together

Feel free to ask me anything—I'm here for you! You can also use the quick buttons below to get started.

💡 Tip: Click "Video Avatar" to switch to video conversation mode (coming soon)
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="quick-buttons">
            <button class="quick-btn" onclick="askQuestion('What is my current glucose level?')">📊 Current Glucose</button>
            <button class="quick-btn" onclick="askQuestion('What patterns have you detected?')">🔍 Patterns</button>
            <button class="quick-btn" onclick="askQuestion('Give me some recommendations')">💡 Recommendations</button>
            <button class="quick-btn" onclick="askQuestion('Show me 24-hour statistics')">📈 Statistics</button>
            <button class="quick-btn" onclick="askQuestion('How is my glucose control?')">✅ Overall Assessment</button>
        </div>

        <div class="chat-input">
            <input 
                type="text" 
                id="messageInput" 
                placeholder="Type your question..."
                onkeypress="handleKeyPress(event)"
            >
            <button onclick="sendMessage()" id="sendBtn">Send</button>
        </div>
    </div>

    <!-- Video Avatar Modal -->
    <div class="modal" id="avatarModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>🎥 Olivia - Video Conversation</h2>
                <button class="modal-close" onclick="closeAvatarModal()">✕</button>
            </div>
            <div class="modal-body">
                <div class="video-container" id="videoContainer">
                    <div class="video-loading">
                        <div class="spinner"></div>
                        <div class="loading-text">Loading video avatar...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUserId = 'user_001';
        const API_BASE = 'http://localhost:5000/api';
        let isAvatarMode = false;
        let messageCount = 0;  // Track message count to save periodically

        // Load user list
        async function loadUserList() {
            try {
                const response = await fetch(`${API_BASE}/users`);
                const users = await response.json();
                
                const select = document.getElementById('userSelect');
                select.innerHTML = users.map(user => 
                    `<option value="${user.user_id}">${user.name} (${user.user_id})</option>`
                ).join('');
                
                if (users.length > 0) {
                    currentUserId = users[0].user_id;
                    // Initialize GPT chat
                    await initGPTChat();
                }
            } catch (error) {
                console.error('Error loading users:', error);
                addMessage('Unable to load user list. Please ensure the service is running.', 'system');
            }
        }

        // Initialize GPT chat
        async function initGPTChat() {
            try {
                await fetch(`${API_BASE}/avatar/gpt/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUserId })
                });
                messageCount = 0;  // Reset message count
            } catch (error) {
                console.error('Error initializing GPT chat:', error);
            }
        }

        // Change user
        async function changeUser() {
            const select = document.getElementById('userSelect');
            const newUserId = select.value;
            
            // Save previous conversation before switching
            if (currentUserId !== newUserId && messageCount > 0) {
                await saveConversation(currentUserId);
            }
            
            currentUserId = newUserId;
            
            // Clear messages
            document.getElementById('messages').innerHTML = '';
            
            // Reinitialize conversation
            await initGPTChat();
            
            addMessage(`✓ Switched to user: ${currentUserId}\n\nWonderful! I've loaded your health information and I'm ready to support you. What would you like to explore together today?`, 'bot');
        }

        // Save conversation to database
        async function saveConversation(userId) {
            try {
                const response = await fetch(`${API_BASE}/avatar/gpt/end`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log(`✅ Conversation saved: ${result.conversation_id}, Duration: ${result.duration_seconds}s`);
                } else {
                    console.error('Failed to save conversation:', result.message);
                }
            } catch (error) {
                console.error('Error saving conversation:', error);
            }
        }

        // Periodic auto-save (optional)
        async function autoSaveConversation() {
            if (messageCount > 10) {  // Save after 10 messages
                await saveConversation(currentUserId);
                messageCount = 0;
                await initGPTChat();  // Start new conversation session
            }
        }

        // Toggle avatar mode
        function toggleAvatar() {
            isAvatarMode = !isAvatarMode;
            const btn = document.getElementById('avatarBtn');
            
            if (isAvatarMode) {
                btn.classList.add('active');
                btn.innerHTML = '<span>🎥</span><span>Avatar Active</span>';
                openAvatarModal();
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<span>🎥</span><span>Video Avatar</span>';
                closeAvatarModal();
            }
        }

        // Open avatar modal
        function openAvatarModal() {
            const modal = document.getElementById('avatarModal');
            const videoContainer = document.getElementById('videoContainer');
            
            modal.classList.add('active');
            
            // Load video avatar in iframe
            const iframeHTML = `
                <iframe 
                    src="http://localhost:5173"
                    title="Olivia - Video Avatar"
                    allow="microphone;camera;display-capture"
                    sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals"
                    style="width: 100%; height: 100%; border: none; display: block;"
                ></iframe>
            `;
            
            videoContainer.innerHTML = iframeHTML;
        }

        // Close avatar modal
        function closeAvatarModal() {
            const modal = document.getElementById('avatarModal');
            const videoContainer = document.getElementById('videoContainer');
            
            modal.classList.remove('active');
            isAvatarMode = false;
            
            // Clear iframe
            videoContainer.innerHTML = `
                <div class="video-loading">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading video avatar...</div>
                </div>
            `;
            
            // Update button state
            const btn = document.getElementById('avatarBtn');
            btn.classList.remove('active');
            btn.innerHTML = '<span>🎥</span><span>Video Avatar</span>';
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Disable input
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            
            addMessage(message, 'user');
            input.value = '';
            messageCount++;  // Increment message count
            
            // Show typing indicator
            showTyping();
            
            try {
                const response = await fetch(`${API_BASE}/avatar/gpt/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        message: message
                    })
                });
                
                const result = await response.json();
                
                hideTyping();
                
                if (result.success) {
                    let botMessage = result.message;  // Changed from result.response
                    
                    // Add function badge if function was called
                    if (result.function_called) {
                        botMessage += `\n\n<span class="function-badge">📊 Real-time data retrieved</span>`;
                    }
                    
                    addMessage(botMessage, 'bot');
                    messageCount++;  // Increment for bot message
                    
                    // Periodic auto-save
                    await autoSaveConversation();
                } else {
                    addMessage('Sorry, an error occurred: ' + (result.error || result.message), 'bot');
                }
            } catch (error) {
                hideTyping();
                addMessage('Sorry, unable to connect to the server. Please ensure the service is running.', 'bot');
                console.error('Error:', error);
            }
            
            // Re-enable input
            input.disabled = false;
            document.getElementById('sendBtn').disabled = false;
            input.focus();
        }

        // Quick question
        function askQuestion(question) {
            document.getElementById('messageInput').value = question;
            sendMessage();
        }

        // Add message
        function addMessage(text, sender) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            messageDiv.innerHTML = `
                <div class="message-content">${text}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Show typing indicator
        function showTyping() {
            document.getElementById('typingIndicator').classList.add('active');
            const messagesDiv = document.getElementById('messages');
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Hide typing indicator
        function hideTyping() {
            document.getElementById('typingIndicator').classList.remove('active');
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Initialize
        window.onload = function() {
            loadUserList();
        };

        // Save conversation when page unloads
        window.addEventListener('beforeunload', async function(e) {
            // Only save if there are messages
            if (messageCount > 0) {
                await saveConversation(currentUserId);
            }
        });
    </script>
</body>
</html>
